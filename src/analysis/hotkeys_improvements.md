# Рекомендации по улучшению системы горячих клавиш

## Статус выполнения

Используйте чекбоксы для отслеживания прогресса выполнения рекомендаций.

---

## 4. Рекомендации по улучшению

### 4.1 Архитектурные улучшения

#### 4.1.1 Создать централизованный менеджер горячих клавиш

- [x] **Создать класс `HotkeyManager`** для централизованного управления всеми горячими клавишами.

**Преимущества:**
- Единое место для управления привязками
- Возможность показать список всех горячих клавиш
- Легче избежать конфликтов
- Проще тестировать

**Пример структуры:**
```python
class HotkeyManager:
    def __init__(self, root):
        self.root = root
        self.bindings = {}
    
    def register(self, key_combination, handler, component, description=""):
        """Регистрация горячей клавиши."""
        pass
    
    def unregister(self, key_combination, component):
        """Отмена регистрации."""
        pass
    
    def get_all_bindings(self):
        """Получить список всех привязок."""
        pass
```

**Файлы для изменения:**
- Создать `src/utils/hotkey_manager.py`
- Обновить `src/components/python_editor.py`
- Обновить `src/components/output_markdown.py`
- Обновить `src/app.py`

---

#### 4.1.2 Вынести общую логику в утилиты

- [x] **Создать модуль `utils/keyboard_utils.py`** с общими функциями для работы с буфером обмена.

**Пример:**
```python
# utils/keyboard_utils.py
def copy_to_clipboard(widget, text):
    """Универсальная функция копирования."""
    widget.clipboard_clear()
    widget.clipboard_append(text)

def get_selected_text(widget):
    """Получение выделенного текста."""
    try:
        return widget.get("sel.first", "sel.last")
    except tk.TclError:
        return None
```

**Файлы для изменения:**
- Создать `src/utils/keyboard_utils.py`
- Обновить `src/components/python_editor.py`
- Обновить `src/components/python_editor_ctk.py`
- Обновить `src/components/output_markdown.py`

---

### 4.2 Улучшения реализации

#### 4.2.1 Унифицировать обработку регистра

- [x] **Всегда использовать `keysym.lower()`** для нормализации или привязывать оба варианта последовательно.

**Пример:**
```python
def bind_case_insensitive(widget, key, handler):
    """Привязка с учетом обоих регистров."""
    widget.bind(key.lower(), handler, add="+")
    widget.bind(key.upper(), handler, add="+")
```

**Файлы для изменения:**
- `src/components/python_editor.py` (строки 122-134)
- `src/components/python_editor_ctk.py` (строки 60-67)
- `src/components/output_markdown.py` (строки 113-115)

---

#### 4.2.2 Улучшить обработку ошибок

- [x] **Добавить try-except блоки и логирование** во все обработчики.

**Пример:**
```python
def _on_f5(self, event):
    """Обработка нажатия F5 для выполнения кода."""
    try:
        if self.run_code_callback:
            self.run_code_callback()
        return "break"
    except Exception as e:
        logger.error(f"Ошибка выполнения кода: {e}")
        return None
```

**Файлы для изменения:**
- `src/components/python_editor.py` (все методы `_on_*`)
- `src/components/python_editor_ctk.py` (все методы `_handle_*`)
- `src/components/output_markdown.py` (методы `_copy_*`, `_select_all`)
- `src/app.py` (метод `_on_delete_key`)

**Требования:**
- Добавить модуль логирования (если еще нет)
- Обернуть все обработчики в try-except
- Добавить информативные сообщения об ошибках

---

#### 4.2.3 Упростить управление bindtags

- [x] **Использовать контекстный менеджер** для управления bindtags.

**Пример:**
```python
class BindTagContext:
    def __init__(self, widget, tag_name):
        self.widget = widget
        self.tag_name = tag_name
    
    def __enter__(self):
        current_tags = list(self.widget.bindtags())
        if self.tag_name not in current_tags:
            current_tags.insert(0, self.tag_name)
            self.widget.bindtags(current_tags)
        return self
    
    def __exit__(self, *args):
        current_tags = list(self.widget.bindtags())
        if self.tag_name in current_tags:
            current_tags.remove(self.tag_name)
            self.widget.bindtags(current_tags)
```

**Использование:**
```python
with BindTagContext(self.text_widget, "AutocompleteHandlers"):
    self.text_widget.bind_class("AutocompleteHandlers", "<Up>", self._on_key_press_up)
    # ...
```

**Файлы для изменения:**
- Создать `src/utils/bindtag_context.py` или добавить в `keyboard_utils.py`
- Обновить `src/components/python_editor.py` (строки 655-799)

---

### 4.3 Улучшения UX

#### 4.3.1 Добавить меню "Справка" с горячими клавишами

- [x] **Создать диалоговое окно** со списком всех горячих клавиш.

**Пример:**
```python
def show_hotkeys_help(self):
    """Показать справку по горячим клавишам."""
    hotkeys = [
        ("F5", "Выполнить код"),
        ("Ctrl+N", "Создать новый файл"),
        ("Ctrl+S", "Сохранить файл"),
        ("Ctrl+C", "Копировать"),
        ("Ctrl+V", "Вставить"),
        ("Ctrl+X", "Вырезать"),
        ("Ctrl+A", "Выделить всё"),
        ("Ctrl+Space", "Показать автодополнение"),
        ("Tab", "Вставить автодополнение"),
        ("Escape", "Закрыть автодополнение"),
        ("Delete", "Удалить файл (если нет выделенного текста)"),
    ]
    # Показать диалог
```

**Файлы для изменения:**
- Создать `src/components/hotkeys_help_dialog.py`
- Добавить пункт меню в `src/components/toolbar.py` или создать менюбар
- Обновить `src/app.py` для интеграции диалога

**Требования:**
- Красивое форматирование списка
- Группировка по категориям (Редактор, Файлы, Общие)
- Возможность поиска по списку

---

#### 4.3.2 Добавить визуальную обратную связь

- [x] **Показывать уведомления** при выполнении действий через горячие клавиши.

**Пример:**
```python
def _on_ctrl_s(self, event):
    """Обработка сохранения файла."""
    if self.save_file_callback:
        self.save_file_callback()
        self._show_notification("Файл сохранен")
    return "break"
```

**Файлы для изменения:**
- Создать `src/components/notification.py` или использовать существующий механизм
- Обновить `src/components/python_editor.py` (методы `_on_ctrl_s`, `_on_ctrl_n`, `_on_f5`)
- Обновить `src/app.py` (метод `_on_delete_key`)

**Требования:**
- Ненавязчивые уведомления (toast-уведомления)
- Автоматическое скрытие через 2-3 секунды
- Поддержка темной/светлой темы

---

#### 4.3.3 Добавить возможность настройки горячих клавиш

- [x] **Сохранять пользовательские привязки** в конфигурационном файле.

**Пример:**
```python
# config.json
{
    "hotkeys": {
        "run_code": "F5",
        "save_file": "Control-s",
        "create_file": "Control-n",
        "delete_file": "Delete"
    }
}
```

**Файлы для изменения:**
- Обновить `src/utils/data_manager.py` для работы с конфигурацией горячих клавиш
- Создать `src/components/hotkeys_settings_dialog.py`
- Обновить `src/app.py` для загрузки пользовательских привязок

**Требования:**
- Валидация комбинаций клавиш (проверка конфликтов)
- Возможность сброса к значениям по умолчанию
- Сохранение в `app_state.json` или отдельном файле конфигурации

---

## 5. Приоритеты исправления

### Высокий приоритет

- [ ] **1. Унификация обработки стандартных комбинаций** (Ctrl+C, Ctrl+V и т.д.)
   - Критично для стабильности работы
   - Влияет на базовую функциональность
   - **Связано с:** 4.1.2, 4.2.1

- [ ] **2. Исправление конфликтов между компонентами**
   - Может приводить к неожиданному поведению
   - Влияет на UX
   - **Связано с:** 4.1.1, 4.2.1

- [ ] **3. Улучшение обработки ошибок**
   - Предотвращает падения приложения
   - Упрощает отладку
   - **Связано с:** 4.2.2

### Средний приоритет

- [ ] **4. Создание централизованного менеджера**
   - Улучшит архитектуру
   - Упростит поддержку в будущем
   - **Связано с:** 4.1.1

- [ ] **5. Добавление документации горячих клавиш**
   - Улучшит UX
   - Поможет пользователям
   - **Связано с:** 4.3.1

### Низкий приоритет

- [ ] **6. Возможность настройки горячих клавиш**
   - Nice-to-have функция
   - Требует дополнительной инфраструктуры
   - **Связано с:** 4.3.3, 4.1.1

---

## Дополнительные задачи

### Рефакторинг существующего кода

- [ ] **Рефакторинг `python_editor.py`**
   - Упростить логику привязки клавиш
   - Использовать новые утилиты
   - Улучшить обработку ошибок

- [ ] **Рефакторинг `python_editor_ctk.py`**
   - Унифицировать с основной версией
   - Использовать общие утилиты

- [ ] **Рефакторинг `output_markdown.py`**
   - Использовать общие функции копирования
   - Улучшить обработку ошибок

- [ ] **Рефакторинг `app.py`**
   - Переместить обработку Delete в менеджер горячих клавиш
   - Улучшить логику проверки выделенного текста

### Тестирование

- [ ] **Создать unit-тесты для HotkeyManager**
   - Тесты регистрации/отмены регистрации
   - Тесты конфликтов
   - Тесты получения списка привязок

- [ ] **Создать интеграционные тесты**
   - Тесты работы горячих клавиш в редакторе
   - Тесты работы горячих клавиш в окне вывода
   - Тесты конфликтов между компонентами

- [ ] **Создать UI-тесты**
   - Тесты визуальной обратной связи
   - Тесты диалога справки
   - Тесты настроек горячих клавиш

### Документация

- [ ] **Обновить README.md**
   - Добавить раздел о горячих клавишах
   - Описать новые возможности настройки

- [ ] **Создать документацию для разработчиков**
   - Описание архитектуры HotkeyManager
   - Примеры использования
   - Руководство по добавлению новых горячих клавиш

---

## Заметки по реализации

### Порядок выполнения (рекомендуемый)

1. **Этап 1: Фундамент**
   - Создать `keyboard_utils.py` с общими функциями
   - Улучшить обработку ошибок в существующих обработчиках
   - Унифицировать обработку регистра

2. **Этап 2: Централизация**
   - Создать `HotkeyManager`
   - Мигрировать существующие привязки на менеджер
   - Исправить конфликты

3. **Этап 3: UX улучшения**
   - Добавить диалог справки
   - Добавить визуальную обратную связь
   - Добавить возможность настройки

### Оценка времени

- **Этап 1:** 4-6 часов
- **Этап 2:** 8-12 часов
- **Этап 3:** 6-8 часов

**Итого:** 18-26 часов работы

---

*Последнее обновление: 2024*

